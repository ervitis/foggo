# foggo

[![ci](https://github.com/s14t284/foggo/actions/workflows/ci.yml/badge.svg)](https://github.com/s14t284/foggo/actions/workflows/ci.yml)
[![Release](https://github.com/s14t284/foggo/actions/workflows/release.yml/badge.svg)](https://github.com/s14t284/foggo/actions/workflows/release.yml)
[![Coverage Status](https://coveralls.io/repos/github/s14t284/foggo/badge.svg?branch=main)](https://coveralls.io/github/s14t284/foggo?branch=main)


Golang の構造体から `Functional Option Pattern` コードを自動生成する cli 

## Installation

```shell
$ go install golang.org/x/tools/cmd/goimports@latest  # foggo use 'goimports' command
$ go install github.com/s14t284/foggo@latest
```

## Usage

__foggo__ では `foc` サブコマンドを提供しています。
https://ww24.jp/2019/07/go-option-pattern で提案されているような mock を用いたテストでも利用しやすいオプションを自動生成する `afoc` サブコマンドも提供予定です。

```shell
Usage:
  foggo foc [flags]

Flags:
  -h, --help   help for foc

Global Flags:
  -p, --package string   Package name having target struct (default ".")
  -s, --struct string    Target struct name (required)
```

### Generate with command line

1. 以下のように構造体を用意します。optionを提供したくないフィールドには構造体タグに `foggo:"-"` を付与してください。

    ```go
    // ./image/image.go
    package image
    
    type Image struct {
        Width  int
        Height int
        Src    string `foggo:"-"`
        Alt    string
    }
    ```

2. `foggo foc` コマンドを実行。

    ```shell
    # struct パラメータには構造体名を指定します
    # package パラメータには構造体が配置されている相対パスを指定します
    $ foggo foc --struct Image --package image
    ```

3. `foggo` コマンドにより、以下のような Functional Option Pattern のコードが `./image/image_gen.go` に自動生成されます。

    ```go
    // Code generated by foggo; DO NOT EDIT.

    package image

    type ImageOption func(*Image)

    func NewImage(options ...ImageOption) *Image {
        s := &Image{}
    
        for _, option := range options {
            option(s)
        }
    
        return s
    }
    
    func WithWidth(Width int) ImageOption {
        return func(args *Image) {
            args.Width = Width
        }
    }
    
    func WithHeight(Height int) ImageOption {
        return func(args *Image) {
            args.Height = Height
        }
    }

    func WithAlt(Alt string) ImageOption {
        return func(args *Image) {
            args.Alt = Alt
        }
    }
    ```
   
4. あとは`Functional Option Pattern` を使って実装するだけです。

    ```go
    package main
   
    import "github.com/user/project/image"
    
    func main() {
	    image := NewImage(
	    	WithWidth(1280),
	    	WithHeight(720),
	    	WithAlt("alt title"),
	    )
	    image.Src = "./image.png"
        ...
    }
    ```

### Generate with `go:generate`

1. `go:generate` コメントを付与して構造体を定義します。packageパラメータには何も指定しなくて大丈夫です。

    ```go
    // ./image/image.go
    package image
    
    //go:generate foggo foc --struct Image 
    type Image struct {
        Width  int
        Height int
        // don't want to create option, specify `foggo:"-"` as the structure tag 
        Src    string `foggo:"-"`
        Alt    string
    }
    ```

2. `go generate ./...` コマンドを実行してください。

    ```shell
    $ go generate ./...
    ```

3. `go:generate foggo` コメントが付与されている全ての構造体に対して `Functional Option Pattern` コードが自動生成されます。

## Functional Option Pattern ?
`Functional Option Pattern` は Golang でよく使われるデザインパターンの一種です。

Golang では python や ruby で利用できるキーワード引数のようなオプション引数を提供していません。
`Functional Option Pattern` を使うことで、オプション引数を再現します。

以下の記事が詳しいです。

- [Goでオプショナルパラメータをどう扱うか](https://raahii.github.io/posts/optional-parameters-in-go/)
- [Functional Options Pattern に次ぐ、オプション引数を実現する方法](https://ww24.jp/2019/07/go-option-pattern)
- https://commandcenter.blogspot.jp/2014/01/self-referential-functions-and-design.html
- https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis

## References

- https://github.com/moznion/gonstructor
